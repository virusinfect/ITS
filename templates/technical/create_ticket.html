{% extends "base.html" %}
{% load static %}
{% block title %}Create Ticket{% endblock %}
{% block header %}Create Ticket{% endblock %}

{% block content %}
    <div class="row">
        <div class="col-md-6">
            <div class="mb-4">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="javascript: void(0);">Home</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'ticket-list' %}">Tickets</a></li>
                    <li class="breadcrumb-item active">Create Ticket</li>
                </ol>
            </div>
        </div> <!-- end col -->
    </div>
    <div class="col-lg-8 mx-auto">
        <div class="card">
            <div class="card-body">
                <h4 class="mb-3 header-title text-center">Create Ticket</h4>

                <form method="post">
                    {% csrf_token %}
                    <div class="col-11 mx-auto mt-3">
                        <div class="row">

                            <div class="mb-2 col-lg-6">
                                <label for="type" class="form-label"><strong>Ticket
                                    Type:</strong></label>
                                <select id="type" class="form-select" name="type">
                                    <option value="Bench">
                                        Bench
                                    </option>
                                    <option value="On-site">
                                        On site
                                    </option>
                                </select>
                            </div>
                            <div class="col-lg-6 mb-3">
                                <label for="company" class="form-label">Company :</label>
                                <select name="company" class="form-select" id="company" required>
                                    <option value="" disabled selected>Select a company</option>
                                    {% for company in companies %}
                                        <option value="{{ company.id }}">{{ company.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-lg-6 mb-3">
                                <label for="client" class="form-label">Client :</label>
                                <select name="client" class="form-control" id="client" required>
                                    <option value="" disabled selected>Select a client</option>
                                    <option value="" disabled selected>Select a client name</option>
                                </select>
                            </div>
                            <div class="mb-3 col-lg-6">
                                <label for="tech" class="form-label"><strong>Technician:</strong></label>
                                <select id="tech" name="tech" class="form-select" required>
                                    {% for tech_option in users %}
                                        <option value="{{ tech_option.id }}"
                                                {% if tech_option.id == ticket.tech.id %}selected{% endif %}>
                                            {{ tech_option.username }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="row mb-3">

                            <div class="col-lg-6 mb-3">
                                <label for="equipment"
                                       class="form-label"><strong>Equipment:</strong></label>
                                <input type="text" class="form-control" id="equipment"
                                       name="equipment" placeholder="Equipment" required>
                            </div>
                            <div class="col-lg-6 mb-3">
                                <label for="serial_no" class="form-label"><strong>Serial
                                    No:</strong></label>
                                <input type="text" class="form-control" id="serial_no"
                                       name="serial_no" placeholder="Serial No" required>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="mb-3 col-lg-6">
                                <label for="fault" class="form-label"><strong>Fault:</strong></label>
                                <textarea class="form-control" id="fault"
                                          name="fault" rows="5" placeholder="Fault" required></textarea>
                            </div>
                            <div class="mb-3 col-lg-6">

                                <label for="accessories"
                                       class="form-label"><strong>Accessories:</strong></label>
                                <textarea class="form-control" id="accessories"
                                          name="accessories"
                                          rows="5" placeholder="Accessories"></textarea>

                            </div>
                        </div>
                        <div class="row mb-3 mx-auto">
                            <label for="notes"
                                   class="form-label"><strong>Notes:</strong></label>
                            <textarea class="form-control" id="notes"
                                      name="notes" rows="5" placeholder="Other Details"></textarea></div>

                    </div>
                    <canvas id="signature-pad"
                            class="card border shadow-lg bg-body-tertiary rounded mt-2 mx-auto" width="400"
                            height="250"></canvas>
                    <input type="hidden" id="cc_id" value="{{ call_card.cc_id }}">
                </form>

                <button id="save-signature"
                        class="btn btn-primary waves-effect waves-light me-1 mt-2">Create Ticket
                </button>
            </div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/1.5.3/signature_pad.min.js"></script>
    <script>
        var clientNo;
        var clientSelect = document.getElementById('client');

        function attachChangeEventListener() {
            clientSelect.addEventListener('change', function () {
                clientNo = clientSelect.value;
                console.log("Client ID after populating: " + clientNo);
            });
        }

        document.getElementById('company').addEventListener('change', function () {
            var companyId = this.value;
            var clientSelect = document.getElementById('client');
            var clientNo = clientSelect.value;

            // Clear existing options and add the "Select a client" option
            clientSelect.innerHTML = '<option value="" disabled selected>Select a client</option>';

            if (companyId) {
                // Make an AJAX request to fetch clients based on the selected company.
                // Replace the URL with your Django view or API endpoint.
                fetch('/get_clients/?company_id=' + companyId)
                    .then(response => response.json())
                    .then(data => {
                        data.clients.forEach(function (client) {
                            var option = document.createElement('option');
                            option.value = client.id;
                            option.textContent = client.f_name;
                            clientSelect.appendChild(option);
                        });

                        // Now that options are populated, attach the event listener
                        attachChangeEventListener();
                    });
            }
        });


        $(document).ready(function () {
            // Function to clear the signature
            function clearSignature() {
                signaturePad.clear();
            }

            $('#save-signature').click(function () {
                var canvas = document.getElementById('signature-pad');
                var signaturePad = new SignaturePad(canvas);
                var serialNo = $('#serial_no').val();
                var typeNo = $('#type').val();
                var companyNo = $('#company').val();
                var techNo = $('#tech').val();
                var faultNo = $('#fault').val();
                var equipmentNo = $('#equipment').val();
                var accessoriesNo = $('#accessories').val();
                attachChangeEventListener();
                if (equipmentNo && clientNo && serialNo) {
                    var signatureData = signaturePad.toDataURL();
                    $.ajax({
                        url: '/technical/save-signature-view-ticket/',  // Replace with the actual URL
                        method: 'POST',
                        data: {
                            signature_data: signatureData,
                            serial_no: serialNo,
                            accessories: accessoriesNo,
                            equipment: equipmentNo,
                            fault: faultNo,
                            tech: techNo,
                            client: clientNo,
                            company: companyNo,
                            type: typeNo,
                        },
                        success: function (response) {
                            // Check if the response indicates success (you can define this)
                            if (response.success) {
                                window.location.href = '{% url "ticket-list" %}';
                            } else {
                                // Handle failure if needed
                            }
                        }
                    });
                } else {
                    // Handle the case where one or more variables are empty
                    toastr.error("One or more fields are empty", "Validation Error");
                }
            });

            // Attach the clearSignature function to the "Clear Signature" button
            $('#clear-signature').click(clearSignature);
        });
    </script>
{% endblock %}
